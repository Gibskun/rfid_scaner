<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Tag Deletion Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #742a2a;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 25px;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected { background-color: #48bb78; }
        .status-disconnected { background-color: #f56565; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #742a2a;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tag-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }

        .tag-item:hover {
            background-color: #f7fafc;
        }

        .tag-item:last-child {
            border-bottom: none;
        }

        .tag-info {
            flex-grow: 1;
        }

        .tag-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #4a5568;
            font-size: 0.9em;
        }

        .tag-details {
            font-size: 0.8em;
            color: #718096;
            margin-top: 5px;
        }

        .signal-strength {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .signal-strong { background-color: #48bb78; color: white; }
        .signal-medium { background-color: #ed8936; color: white; }
        .signal-weak { background-color: #f56565; color: white; }
        .signal-new { background-color: #4299e1; color: white; }

        .activity-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .activity-time {
            font-size: 0.8em;
            color: #718096;
            white-space: nowrap;
            min-width: 60px;
        }

        .activity-message {
            flex-grow: 1;
            font-size: 0.9em;
            color: #4a5568;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        .refresh-button {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .refresh-button:hover {
            transform: translateY(-2px);
        }

        .back-button {
            background: rgba(255, 255, 255, 0.8);
            color: #742a2a;
            border: 2px solid rgba(245, 101, 101, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(245, 101, 101, 0.1);
            border-color: #f56565;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(245, 101, 101, 0.3);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                justify-content: center;
            }
        }

        .footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: #718096;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .close {
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .tag-deletion-info {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .tag-deletion-info p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        .deletion-warning {
            color: #c53030;
            font-weight: 500;
            margin-top: 15px !important;
            padding: 10px;
            background: #fed7d7;
            border-left: 4px solid #f56565;
            border-radius: 4px;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-danger {
            background: linear-gradient(135deg, #f56565 0%, #c53030 100%);
            color: white;
        }

        .btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(245, 101, 101, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-1px);
        }

        .deletion-status, .unregister-status {
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            text-align: center;
        }

        .deletion-status.success, .unregister-status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .deletion-status.error, .unregister-status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        /* Pulse animation for registered tags that can be deleted */
        .can-delete {
            animation: pulseDanger 2s infinite;
        }

        @keyframes pulseDanger {
            0% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(245, 101, 101, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(245, 101, 101, 0);
            }
        }

        .warning-note {
            background: #fff5f5;
            border: 1px solid #fed7d7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            color: #742a2a;
        }

        .warning-note h3 {
            color: #c53030;
            margin-bottom: 10px;
        }

        /* Auto-unregistration notification styles */
        .auto-unregister-notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 8px 25px rgba(72, 187, 120, 0.3);
            z-index: 2000;
            max-width: 400px;
            transform: translateX(500px);
            opacity: 0;
            transition: all 0.5s ease;
        }

        .auto-unregister-notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .notification-title {
            font-weight: bold;
            font-size: 1.1em;
        }

        .notification-close {
            cursor: pointer;
            font-size: 1.5em;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .notification-close:hover {
            opacity: 1;
        }

        .notification-content {
            font-size: 0.9em;
            line-height: 1.4;
        }

        .notification-tag-info {
            background: rgba(255, 255, 255, 0.1);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-family: 'Courier New', monospace;
        }

        /* Auto-unregistered tag styling */
        .auto-unregistered {
            background: rgba(72, 187, 120, 0.05) !important;
            border-left: 4px solid #48bb78;
        }

        .auto-unregistered .tag-id {
            color: #38a169;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>ü§ñ RFID Auto-Unregistration Dashboard</h1>
            <p>Automatic RFID tag unregistration with real-time notifications</p>
            
            <div class="warning-note">
                <h3>ü§ñ Automatic Unregistration</h3>
                <p>This system now <strong>automatically unregisters</strong> RFID tags when they are detected. When an active registered tag is placed near the reader, it will be immediately unregistered without user interaction. Historical data is preserved and tags can be re-registered later.</p>
                <p><strong>üîî Notifications:</strong> You will see a green notification when a tag is automatically unregistered.</p>
            </div>
            
            <div class="header-controls">
                <div class="header-left">
                    <a href="/" class="back-button">
                        ‚Üê Back to Main Dashboard
                    </a>
                </div>
                <div class="header-right">
                    <button class="refresh-button" onclick="refreshData()">üîÑ Refresh</button>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="connectionIndicator"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>üì° Scanning: </span>
                    <span id="scanningStatus">Initializing...</span>
                </div>
                <div class="status-item">
                    <span>‚è±Ô∏è Uptime: </span>
                    <span id="uptime">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Statistics Panel -->
            <div class="panel">
                <h2>üìä System Statistics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalScans">0</div>
                        <div class="stat-label">Total Scans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeTags">0</div>
                        <div class="stat-label">Active Tags</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="registeredTags">0</div>
                        <div class="stat-label">Registered Tags</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="nonActiveTags">0</div>
                        <div class="stat-label">Unregistered Tags</div>
                    </div>
                </div>
            </div>

            <!-- Active Tags Panel -->
            <div class="panel">
                <h2>ü§ñ Auto-Unregistered Tags (<span id="tagCount">0</span>)</h2>
                
                <div class="tag-list" id="tagList">
                    <div class="empty-state">
                        <p>No active registered tags detected</p>
                        <p>Place registered RFID tags near the reader to unregister them</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Panel -->
        <div class="panel">
            <h2>üìã Recent Auto-Unregistration Activity</h2>
            
            <div class="activity-list" id="activityList">
                <div class="empty-state">
                    <p>No recent unregister activity</p>
                    <p>Activity will appear here when tags are unregistered</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>RFID Auto-Unregistration Dashboard | Real-time automatic processing | Last updated: <span id="lastUpdate">Never</span></p>
        </div>
    </div>

    <!-- Auto-unregistration Notification -->
    <div id="autoUnregisterNotification" class="auto-unregister-notification">
        <div class="notification-header">
            <div class="notification-title">ü§ñ Auto-Unregistration</div>
            <div class="notification-close" onclick="hideAutoUnregisterNotification()">&times;</div>
        </div>
        <div class="notification-content">
            <div id="notificationMessage">RFID tag automatically unregistered</div>
            <div id="notificationTagInfo" class="notification-tag-info"></div>
        </div>
    </div>

    <!-- Unregister Modal -->
    <div id="unregisterModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>ÔøΩ Unregister RFID Tag</h3>
                <span class="close" onclick="closeUnregisterModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="tag-deletion-info">
                    <p><strong>Tag ID:</strong> <span id="modalTagId">-</span></p>
                    <p><strong>RF ID:</strong> <span id="modalRfId">-</span></p>
                    <p><strong>Item Name:</strong> <span id="modalItemName">-</span></p>
                    <p><strong>Palette Number:</strong> <span id="modalPaletteNumber">-</span></p>
                    <p><strong>Detection Time:</strong> <span id="modalDetectionTime">-</span></p>
                    <p class="deletion-warning">‚ö†Ô∏è This action will unregister this tag (set status to non_active). Historical data will be preserved and the tag can be re-registered later.</p>
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-danger" onclick="unregisterCurrentTag()">ÔøΩ Unregister Tag</button>
                    <button class="btn btn-secondary" onclick="cancelUnregister()">‚ùå Cancel</button>
                </div>
                
                <div id="unregisterStatus" class="unregister-status"></div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        
        // Current tag being processed
        let currentTag = null;
        
        // Connect to server
        socket.on('connect', function() {
            console.log('Connected to server');
            updateConnectionStatus(true);
        });
        
        socket.on('disconnect', function() {
            console.log('Disconnected from server');
            updateConnectionStatus(false);
        });
        
        // Receive initial data
        socket.on('initial_data', function(data) {
            console.log('Received initial data:', data);
            updateDashboard(data);
        });
        
        // Receive real-time updates
        socket.on('status_update', function(data) {
            updateDashboard(data);
        });
        
        // Handle scan status updates
        socket.on('scan_status', function(data) {
            document.getElementById('scanningStatus').textContent = data.status;
        });
        
        function updateConnectionStatus(connected) {
            const indicator = document.getElementById('connectionIndicator');
            const status = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                status.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-disconnected';  
                status.textContent = 'Disconnected';
            }
        }
        
        // Auto-unregistration notification functions
        let notificationTimeout = null;
        
        function showAutoUnregisterNotification(tagInfo, message) {
            const notification = document.getElementById('autoUnregisterNotification');
            const messageDiv = document.getElementById('notificationMessage');
            const tagInfoDiv = document.getElementById('notificationTagInfo');
            
            messageDiv.textContent = message || 'RFID tag automatically unregistered';
            
            let tagDetails = '';
            if (tagInfo) {
                const tagId = tagInfo.tag_id || tagInfo.id || 'Unknown';
                const rfId = tagInfo.rf_id || 'N/A';
                const name = tagInfo.name || 'N/A';
                const palette = tagInfo.palette_number || 'N/A';
                
                tagDetails = `Tag ID: ${tagId.substring(0, 20)}...\nRFID: ${rfId}\nName: ${name}\nPalette: ${palette}`;
            }
            tagInfoDiv.textContent = tagDetails;
            
            // Show notification
            notification.classList.add('show');
            
            // Clear existing timeout
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
            }
            
            // Auto-hide after 8 seconds
            notificationTimeout = setTimeout(() => {
                hideAutoUnregisterNotification();
            }, 8000);
        }
        
        function hideAutoUnregisterNotification() {
            const notification = document.getElementById('autoUnregisterNotification');
            notification.classList.remove('show');
            
            if (notificationTimeout) {
                clearTimeout(notificationTimeout);
                notificationTimeout = null;
            }
        }

        function updateDashboard(data) {
            console.log('Updating dashboard with:', data);
            
            const stats = data.statistics || {};
            
            // Check for auto-unregistration activities
            checkForAutoUnregistrations(data.recent_activity || []);
            
            // Update statistics
            document.getElementById('totalScans').textContent = stats.total_scans || 0;
            document.getElementById('activeTags').textContent = stats.active_tag_count || 0;
            document.getElementById('registeredTags').textContent = calculateRegisteredTags(data.active_tags || {});
            
            // Get database statistics for non-active tags count
            fetch('/api/database/stats')
                .then(response => response.json())
                .then(dbStats => {
                    if (dbStats.success && dbStats.data) {
                        document.getElementById('nonActiveTags').textContent = dbStats.data.non_active_tags || 0;
                    }
                })
                .catch(error => console.log('Error fetching database stats:', error));
            
            // Update uptime
            if (stats.uptime) {
                const hours = Math.floor(stats.uptime / 3600);
                const minutes = Math.floor((stats.uptime % 3600) / 60);
                const seconds = Math.floor(stats.uptime % 60);
                document.getElementById('uptime').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }
            
            // Update scanning status
            document.getElementById('scanningStatus').textContent = stats.scanning ? 'Active' : 'Inactive';
            
            // Update active tags (only show registered tags that can be unregistered)
            updateTagList(data.active_tags || {});
            
            // Update activity list
            updateActivityList(data.recent_activity || []);
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
            
            // Auto-unregistration is handled automatically - no user interaction needed
        }
        
        function checkForAutoUnregistrations(activities) {
            // Look for recent auto-unregistration activities
            const recentAutoUnregistrations = activities.filter(activity => 
                activity.type === 'tag_auto_unregistered' && 
                isRecentActivity(activity.time)
            );
            
            // Show notification for the most recent auto-unregistration
            if (recentAutoUnregistrations.length > 0) {
                const latestUnregistration = recentAutoUnregistrations[0];
                
                // Extract tag info from the activity message
                const message = latestUnregistration.message;
                const tagId = latestUnregistration.tag_id;
                
                // Parse RFID and Name from the message
                const rfidMatch = message.match(/RFID:\s*([^,]+)/);
                const nameMatch = message.match(/Name:\s*([^,\]]+)/);
                
                const tagInfo = {
                    tag_id: tagId,
                    rf_id: rfidMatch ? rfidMatch[1].trim() : 'N/A',
                    name: nameMatch ? nameMatch[1].trim() : 'N/A',
                    palette_number: 'N/A'
                };
                
                showAutoUnregisterNotification(tagInfo, 'RFID tag detected and automatically unregistered');
            }
        }
        
        function isRecentActivity(timeString) {
            // Check if activity happened in the last 5 seconds
            try {
                const now = new Date();
                const activityTime = new Date();
                const timeParts = timeString.split(':');
                activityTime.setHours(parseInt(timeParts[0]), parseInt(timeParts[1]), parseInt(timeParts[2]));
                
                const diffInSeconds = (now - activityTime) / 1000;
                return Math.abs(diffInSeconds) < 5; // Within 5 seconds
            } catch (e) {
                return false;
            }
        }
        
        function calculateRegisteredTags(activeTags) {
            let registered = 0;
            for (const tagId in activeTags) {
                // In unregister mode, we consider a tag registered if it has is_registered = true and status = 'active'
                if (activeTags[tagId].is_registered && activeTags[tagId].status === 'active') {
                    registered++;
                }
            }
            return registered;
        }
        
        function updateTagList(activeTags) {
            const tagList = document.getElementById('tagList');
            const tagCount = document.getElementById('tagCount');
            
            // Filter only unregistered tags (auto-unregistered or never registered)
            const unregisteredTags = {};
            for (const tagId in activeTags) {
                const tagInfo = activeTags[tagId];
                // Show tags that are not registered or have status 'non_active' (auto-unregistered)
                if (!tagInfo.is_registered || tagInfo.status === 'non_active') {
                    unregisteredTags[tagId] = tagInfo;
                }
            }
            
            const unregisteredCount = Object.keys(unregisteredTags).length;
            tagCount.textContent = unregisteredCount;
            
            if (unregisteredCount === 0) {
                tagList.innerHTML = `
                    <div class="empty-state">
                        <p>No unregistered tags detected</p>
                        <p>Tags will appear here after automatic unregistration</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            for (const [tagId, tagInfo] of Object.entries(unregisteredTags)) {
                const displayId = tagInfo.id || tagId;
                const signalClass = `signal-${(tagInfo.signal_strength || 'new').toLowerCase()}`;
                const isAutoUnregistered = tagInfo.status === 'non_active';
                
                html += `
                    <div class="tag-item ${isAutoUnregistered ? 'auto-unregistered' : ''}" data-tag-id="${tagId}">
                        <div class="tag-info">
                            <div class="tag-id">${displayId}</div>
                            <div class="tag-details">
                                ${isAutoUnregistered ? 'ü§ñ AUTO-UNREGISTERED | ' : ''}
                                RF ID: ${tagInfo.rf_id || 'N/A'} | 
                                Name: ${tagInfo.name || 'N/A'} | 
                                Palette: ${tagInfo.palette_number || 'N/A'} |
                                Count: ${tagInfo.count || 1} | 
                                Duration: ${formatDuration(tagInfo.duration || 0)}
                            </div>
                        </div>
                        <div class="signal-strength ${signalClass}">
                            ${isAutoUnregistered ? 'Unregistered' : tagInfo.signal_strength || 'New'}
                        </div>
                    </div>
                `;
            }
            
            tagList.innerHTML = html;
        }
        
        function updateActivityList(activities) {
            const activityList = document.getElementById('activityList');
            
            if (!activities || activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <p>No recent auto-unregistration activity</p>
                        <p>Activity will appear here when tags are automatically unregistered</p>
                    </div>
                `;
                return;
            }
            
            let html = '';
            activities.forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-time">${activity.time}</div>
                        <div class="activity-message">${activity.message}</div>
                    </div>
                `;
            });
            
            activityList.innerHTML = html;
        }
        
        // Auto-unregistration happens automatically - no user interaction needed
        
        function promptUnregisterTag(tagId) {
            // Find tag info from active tags data
            socket.emit('get_status'); // Get fresh data
            
            // Get tag info from API for accurate data
            fetch(`/api/tag/${encodeURIComponent(tagId)}`)
                .then(response => response.json())
                .then(data => {
                    if (data.success && data.data) {
                        const tagInfo = data.data;
                        
                        // Set current tag
                        currentTag = {
                            id: tagId,
                            rf_id: tagInfo.rf_id || 'N/A',
                            name: tagInfo.name || 'N/A',
                            palette_number: tagInfo.palette_number || 'N/A',
                            detection_time: new Date().toLocaleTimeString()
                        };
                        
                        // Update modal
                        document.getElementById('modalTagId').textContent = tagId;
                        document.getElementById('modalRfId').textContent = currentTag.rf_id;
                        document.getElementById('modalItemName').textContent = currentTag.name;
                        document.getElementById('modalPaletteNumber').textContent = currentTag.palette_number;
                        document.getElementById('modalDetectionTime').textContent = currentTag.detection_time;
                        
                        // Clear previous status
                        document.getElementById('unregisterStatus').textContent = '';
                        document.getElementById('unregisterStatus').className = 'unregister-status';
                        
                        // Show modal
                        document.getElementById('unregisterModal').style.display = 'flex';
                    } else {
                        alert('Failed to get tag information');
                    }
                })
                .catch(error => {
                    console.error('Error getting tag info:', error);
                    alert('Error getting tag information');
                });
        }
        
        function unregisterCurrentTag() {
            if (!currentTag) return;
            
            const statusDiv = document.getElementById('unregisterStatus');
            statusDiv.textContent = 'Unregistering tag...';
            statusDiv.className = 'unregister-status';
            
            // Send unregister request
            fetch('/api/unregister-tag', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    tag_id: currentTag.id
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    statusDiv.textContent = data.message || 'Tag unregistered successfully!';
                    statusDiv.className = 'unregister-status success';
                    
                    // Close modal after short delay
                    setTimeout(() => {
                        closeUnregisterModal();
                        refreshData();
                    }, 1500);
                } else {
                    statusDiv.textContent = data.error || 'Failed to unregister tag';
                    statusDiv.className = 'unregister-status error';
                }
            })
            .catch(error => {
                console.error('Error unregistering tag:', error);
                statusDiv.textContent = 'Network error occurred';
                statusDiv.className = 'unregister-status error';
            });
        }
        
        function cancelUnregister() {
            closeUnregisterModal();
        }
        
        function closeUnregisterModal() {
            document.getElementById('unregisterModal').style.display = 'none';
            currentTag = null;
        }
        
        function formatDuration(seconds) {
            if (seconds < 60) return `${seconds.toFixed(1)}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = Math.floor(seconds % 60);
            return `${minutes}m ${remainingSeconds}s`;
        }
        
        function refreshData() {
            socket.emit('get_status');
        }
        
        // Initial data request
        socket.emit('get_status');
    </script>
</body>
</html>