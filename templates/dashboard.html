<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RFID Scanner Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.0.0/socket.io.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
            margin-top: 20px;
        }

        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 15px;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 25px;
            font-weight: 600;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .status-connected { background-color: #48bb78; }
        .status-disconnected { background-color: #f56565; }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.6; }
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 25px;
            margin-bottom: 25px;
        }

        .panel {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .panel h2 {
            color: #4a5568;
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 20px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 2em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .tag-list {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
        }

        .tag-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #e2e8f0;
            transition: background-color 0.2s;
        }

        .tag-item:hover {
            background-color: #f7fafc;
        }

        .tag-item:last-child {
            border-bottom: none;
        }

        .tag-info {
            flex-grow: 1;
        }

        .tag-id {
            font-family: 'Courier New', monospace;
            font-weight: bold;
            color: #4a5568;
            font-size: 0.9em;
        }

        .tag-details {
            font-size: 0.8em;
            color: #718096;
            margin-top: 5px;
        }

        .signal-strength {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.7em;
            font-weight: bold;
            text-transform: uppercase;
        }

        .signal-strong { background-color: #48bb78; color: white; }
        .signal-medium { background-color: #ed8936; color: white; }
        .signal-weak { background-color: #f56565; color: white; }
        .signal-new { background-color: #4299e1; color: white; }

        .activity-list {
            max-height: 350px;
            overflow-y: auto;
        }

        .activity-item {
            display: flex;
            align-items: flex-start;
            gap: 10px;
            padding: 10px 0;
            border-bottom: 1px solid #e2e8f0;
        }

        .activity-time {
            font-size: 0.8em;
            color: #718096;
            white-space: nowrap;
            min-width: 60px;
        }

        .activity-message {
            flex-grow: 1;
            font-size: 0.9em;
            color: #4a5568;
        }

        .empty-state {
            text-align: center;
            color: #718096;
            font-style: italic;
            padding: 40px;
        }

        .refresh-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: transform 0.2s;
        }

        .refresh-button:hover {
            transform: translateY(-2px);
        }

        .back-button {
            background: rgba(255, 255, 255, 0.8);
            color: #4a5568;
            border: 2px solid rgba(102, 126, 234, 0.3);
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .back-button:hover {
            background: rgba(102, 126, 234, 0.1);
            border-color: #667eea;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }

        .header-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            margin-top: 15px;
        }

        .header-left {
            display: flex;
            align-items: center;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        @media (max-width: 768px) {
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .status-bar {
                justify-content: center;
            }
        }

        .footer {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            color: #718096;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            background: white;
            border-radius: 15px;
            padding: 0;
            max-width: 500px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            animation: modalSlideIn 0.3s ease-out;
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-50px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px 15px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-header h3 {
            margin: 0;
            font-size: 1.4em;
        }

        .close {
            font-size: 2em;
            cursor: pointer;
            line-height: 1;
            opacity: 0.8;
            transition: opacity 0.2s;
        }

        .close:hover {
            opacity: 1;
        }

        .modal-body {
            padding: 25px;
        }

        .tag-registration-info {
            background: #f8f9ff;
            border: 1px solid #e2e8f0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .tag-registration-info p {
            margin: 8px 0;
            font-size: 0.95em;
        }

        .registration-note {
            color: #d69e2e;
            font-weight: 500;
            margin-top: 15px !important;
            padding: 10px;
            background: #fef5e7;
            border-left: 4px solid #d69e2e;
            border-radius: 4px;
        }

        .historical-data-section {
            margin: 20px 0;
            padding: 15px;
            background: #e6fffa;
            border: 1px solid #38b2ac;
            border-radius: 8px;
        }

        .historical-header h4 {
            color: #2c7a7b;
            margin: 0 0 8px 0;
            font-size: 1.1em;
        }

        .historical-note {
            color: #2d3748;
            font-size: 0.9em;
            margin: 0 0 15px 0;
            font-style: italic;
        }

        .historical-info {
            background: #f0fdfa;
            padding: 12px;
            border-radius: 6px;
            border: 1px solid #b2f5ea;
        }

        .historical-info p {
            margin: 5px 0;
            color: #2d3748;
            font-size: 0.95em;
        }

        .historical-info strong {
            color: #2c7a7b;
            font-weight: 600;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #4a5568;
        }

        .input-group input {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1em;
            transition: border-color 0.2s;
        }

        .input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .input-group input[type="number"] {
            appearance: textfield;
            -moz-appearance: textfield;
        }

        .input-group input[type="number"]::-webkit-outer-spin-button,
        .input-group input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }

        .modal-buttons {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex: 1;
        }

        .btn-primary {
            background: linear-gradient(135deg, #48bb78 0%, #38a169 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(72, 187, 120, 0.3);
        }

        .btn-secondary {
            background: #e2e8f0;
            color: #4a5568;
        }

        .btn-secondary:hover {
            background: #cbd5e0;
            transform: translateY(-1px);
        }

        .registration-status {
            padding: 10px;
            border-radius: 6px;
            font-size: 0.9em;
            text-align: center;
        }

        .registration-status.success {
            background: #c6f6d5;
            color: #22543d;
            border: 1px solid #9ae6b4;
        }

        .registration-status.error {
            background: #fed7d7;
            color: #742a2a;
            border: 1px solid #fc8181;
        }

        /* Pulse animation for unregistered tags */
        .needs-registration {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>üè∑Ô∏è RFID Scanner Dashboard</h1>
            <p>Real-time tag monitoring and detection system</p>
            
            <div class="header-controls">
                <div class="header-left">
                    <a href="/" class="back-button">
                        ‚Üê Back to Main Dashboard
                    </a>
                </div>
                <div class="header-right">
                    <button class="refresh-button" onclick="refreshData()">üîÑ Refresh</button>
                </div>
            </div>
            
            <div class="status-bar">
                <div class="status-item">
                    <div class="status-indicator" id="connectionIndicator"></div>
                    <span id="connectionStatus">Connecting...</span>
                </div>
                <div class="status-item">
                    <span>üì° Scanning: </span>
                    <span id="scanningStatus">Initializing...</span>
                </div>
                <div class="status-item">
                    <span>‚è±Ô∏è Uptime: </span>
                    <span id="uptime">00:00:00</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Statistics Panel -->
            <div class="panel">
                <h2>üìä Statistics</h2>
                
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-value" id="totalScans">0</div>
                        <div class="stat-label">Total Scans</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="activeTags">0</div>
                        <div class="stat-label">Active Tags</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalDetections">0</div>
                        <div class="stat-label">Total Detections</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="scanRate">0.0</div>
                        <div class="stat-label">Scans/sec</div>
                    </div>
                </div>
            </div>

            <!-- Active Tags Panel -->
            <div class="panel">
                <h2>üè∑Ô∏è Active Tags (<span id="tagCount">0</span>)</h2>
                
                <div class="tag-list" id="tagList">
                    <div class="empty-state">
                        <p>No active tags detected</p>
                        <p>Place RFID tags near the reader to begin detection</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Activity Panel -->
        <div class="panel">
            <h2>üìã Recent Activity</h2>
            
            <div class="activity-list" id="activityList">
                <div class="empty-state">
                    <p>No recent activity</p>
                    <p>Activity will appear here when tags are detected</p>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <div class="footer">
            <p>RFID Scanner Dashboard | Real-time updates via WebSocket | Last updated: <span id="lastUpdate">Never</span></p>
        </div>
    </div>

    <!-- Registration Modal -->
    <div id="registrationModal" class="modal" style="display: none;">
        <div class="modal-content">
            <div class="modal-header">
                <h3>üÜï New RFID Tag Detected</h3>
                <span class="close" onclick="closeRegistrationModal()">&times;</span>
            </div>
            
            <div class="modal-body">
                <div class="tag-registration-info">
                    <p><strong>Tag ID:</strong> <span id="modalTagId">-</span></p>
                    <p><strong>Detection Time:</strong> <span id="modalDetectionTime">-</span></p>
                    <p id="registrationNote" class="registration-note">‚ö†Ô∏è This tag is not registered in the database. Please provide the registration details.</p>
                </div>
                
                <!-- Historical Data Section for Reused Tags -->
                <div id="historicalDataSection" class="historical-data-section" style="display: none;">
                    <div class="historical-header">
                        <h4>üìã Previous Usage History</h4>
                        <p class="historical-note">This tag was previously used and deactivated. The data below is for reference only.</p>
                    </div>
                    <div class="historical-info">
                        <p><strong>Previous RFID:</strong> <span id="previousRfId">-</span></p>
                        <p><strong>Previous Name:</strong> <span id="previousName">-</span></p>
                        <p><strong>Previous Palette:</strong> <span id="previousPalette">-</span></p>
                        <p><strong>Deactivated:</strong> <span id="deactivatedDate">-</span></p>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="rfIdInput">RFID (RF ID):</label>
                    <div style="display: flex; gap: 10px; align-items: stretch;">
                        <input type="text" id="rfIdInput" placeholder="Enter RFID or click Generate" maxlength="255" style="flex: 1;" />
                        <button type="button" class="btn btn-secondary" onclick="generateRFID()" style="flex: none; padding: 8px 15px; white-space: nowrap;">üé≤ Generate</button>
                    </div>
                </div>
                
                <div class="input-group">
                    <label for="paletteNumberInput">Palette Number (optional):</label>
                    <input type="number" id="paletteNumberInput" placeholder="Enter palette number (e.g., 123)" min="1" max="999999" />
                </div>
                
                <div class="input-group">
                    <label for="nameInput">Name (optional):</label>
                    <input type="text" id="nameInput" placeholder="Enter item name (e.g., Laptop Charger)" maxlength="255" />
                </div>
                
                <div class="modal-buttons">
                    <button class="btn btn-primary" onclick="registerCurrentTag()">‚úÖ Register Tag</button>
                    <button class="btn btn-secondary" onclick="skipCurrentTag()">‚è≠Ô∏è Skip</button>
                </div>
                
                <div id="registrationStatus" class="registration-status"></div>
            </div>
        </div>
    </div>

    <script>
        // WebSocket connection
        const socket = io();
        let startTime = Date.now();

        // Update functions
        function updateConnectionStatus(connected, status) {
            const indicator = document.getElementById('connectionIndicator');
            const statusText = document.getElementById('connectionStatus');
            
            if (connected) {
                indicator.className = 'status-indicator status-connected';
                statusText.textContent = 'Connected';
            } else {
                indicator.className = 'status-indicator status-disconnected';
                statusText.textContent = status || 'Disconnected';
            }
        }

        function updateStatistics(stats) {
            document.getElementById('totalScans').textContent = stats.total_scans || 0;
            document.getElementById('activeTags').textContent = stats.active_tag_count || 0;
            document.getElementById('totalDetections').textContent = stats.total_detections || 0;
            document.getElementById('scanRate').textContent = (stats.scan_rate || 0).toFixed(1);
            document.getElementById('tagCount').textContent = stats.active_tag_count || 0;
            
            // Update scanning status
            document.getElementById('scanningStatus').textContent = stats.scanning ? 'Active' : 'Inactive';
        }

        function updateTags(tags) {
            const tagList = document.getElementById('tagList');
            
            if (!tags || Object.keys(tags).length === 0) {
                tagList.innerHTML = `
                    <div class="empty-state">
                        <p>No active tags detected</p>
                        <p>Place RFID tags near the reader to begin detection</p>
                    </div>
                `;
                return;
            }

            let html = '';
            for (const [tagId, tagInfo] of Object.entries(tags)) {
                const signalClass = `signal-${(tagInfo.signal_strength || 'new').toLowerCase()}`;
                const displayId = tagId.length > 30 ? tagId.substring(0, 30) + '...' : tagId;
                
                // Build registration info for registered tags
                let registrationInfo = '';
                if (tagInfo.is_registered) {
                    const infoParts = [];
                    if (tagInfo.rf_id) {
                        infoParts.push(`üÜî RFID: ${tagInfo.rf_id}`);
                    }
                    if (tagInfo.palette_number) {
                        infoParts.push(`üì¶ Palette: #${tagInfo.palette_number}`);
                    }
                    if (tagInfo.name) {
                        infoParts.push(`üè∑Ô∏è Name: ${tagInfo.name}`);
                    }
                    registrationInfo = infoParts.join(' | ');
                } else {
                    registrationInfo = '‚ö†Ô∏è UNREGISTERED - Click to register';
                }
                
                const itemClass = tagInfo.is_registered ? '' : 'needs-registration';
                
                html += `
                    <div class="tag-item ${itemClass}">
                        <div class="tag-info">
                            <div class="tag-id">${displayId}</div>
                            <div class="tag-details">
                                ${registrationInfo}
                            </div>
                            <div class="tag-details" style="margin-top: 3px; font-size: 0.75em;">
                                Detections: ${tagInfo.count || 1} | Last seen: ${tagInfo.last_seen || 'Just now'}
                            </div>
                        </div>
                        <div class="signal-strength ${signalClass}">
                            ${tagInfo.signal_strength || 'New'}
                        </div>
                    </div>
                `;
            }
            tagList.innerHTML = html;
        }

        function updateActivity(activities) {
            const activityList = document.getElementById('activityList');
            
            if (!activities || activities.length === 0) {
                activityList.innerHTML = `
                    <div class="empty-state">
                        <p>No recent activity</p>
                        <p>Activity will appear here when tags are detected</p>
                    </div>
                `;
                return;
            }

            let html = '';
            activities.slice(0, 20).forEach(activity => {
                html += `
                    <div class="activity-item">
                        <div class="activity-time">${activity.time}</div>
                        <div class="activity-message">${activity.message}</div>
                    </div>
                `;
            });
            activityList.innerHTML = html;
        }

        function updateUptime() {
            const now = Date.now();
            const diff = now - startTime;
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            document.getElementById('uptime').textContent = 
                `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        function refreshData() {
            socket.emit('get_status');
        }

        // Socket event handlers
        socket.on('connect', function() {
            console.log('Connected to RFID system');
            updateConnectionStatus(true, 'Connected');
            refreshData();
        });

        socket.on('disconnect', function() {
            console.log('Disconnected from RFID system');
            updateConnectionStatus(false, 'Disconnected');
        });

        socket.on('initial_data', function(data) {
            console.log('Received initial data:', data);
            updateData(data);
        });

        socket.on('status_update', function(data) {
            console.log('Status update:', data);
            updateData(data);
        });

        // Start uptime counter
        setInterval(updateUptime, 1000);
        updateUptime();

        // Auto-refresh every 30 seconds
        setInterval(refreshData, 30000);

        // Registration Modal Functions
        let currentRegistrationTag = null;

        function showRegistrationModal(tagData) {
            currentRegistrationTag = tagData;
            
            // Update modal content
            document.getElementById('modalTagId').textContent = tagData.tag_hex;
            document.getElementById('modalDetectionTime').textContent = new Date().toLocaleString();
            
            // Check if this is a reused tag with historical data
            const isReusedTag = tagData.was_reused;
            const historicalSection = document.getElementById('historicalDataSection');
            const registrationNote = document.getElementById('registrationNote');
            
            if (isReusedTag && tagData.previous_rf_id) {
                // Show historical data section
                historicalSection.style.display = 'block';
                document.getElementById('previousRfId').textContent = tagData.previous_rf_id || '-';
                document.getElementById('previousName').textContent = tagData.previous_name || 'Not specified';
                document.getElementById('previousPalette').textContent = tagData.previous_palette ? `#${tagData.previous_palette}` : 'Not specified';
                document.getElementById('deactivatedDate').textContent = tagData.deactivated_date ? new Date(tagData.deactivated_date).toLocaleString() : '-';
                
                // Update registration note for reused tag
                registrationNote.innerHTML = 'üîÑ This tag was previously used and can be reused with new data. Previous usage data is shown below for reference.';
                registrationNote.style.color = '#2c7a7b';
                registrationNote.style.background = '#e6fffa';
                registrationNote.style.borderLeftColor = '#38b2ac';
            } else {
                // Hide historical data section for new tags
                historicalSection.style.display = 'none';
                registrationNote.innerHTML = '‚ö†Ô∏è This tag is not registered in the database. Please provide the registration details.';
                registrationNote.style.color = '#d69e2e';
                registrationNote.style.background = '#fef5e7';
                registrationNote.style.borderLeftColor = '#d69e2e';
            }
            
            // Clear input fields
            document.getElementById('rfIdInput').value = '';
            document.getElementById('paletteNumberInput').value = '';
            document.getElementById('nameInput').value = '';
            document.getElementById('registrationStatus').textContent = '';
            document.getElementById('registrationStatus').className = 'registration-status';
            
            // Show modal
            document.getElementById('registrationModal').style.display = 'flex';
            
            // Focus on RFID input
            setTimeout(() => {
                document.getElementById('rfIdInput').focus();
            }, 300);
        }

        function closeRegistrationModal() {
            document.getElementById('registrationModal').style.display = 'none';
            currentRegistrationTag = null;
            
            // Check for next pending registration
            setTimeout(checkPendingRegistrations, 500);
        }

        function generateRFID() {
            // Generate a unique RFID (RF ID) - using timestamp and random numbers
            const timestamp = Date.now().toString(36);
            const random = Math.random().toString(36).substring(2, 8);
            const rfid = `RF${timestamp}${random}`.toUpperCase();
            document.getElementById('rfIdInput').value = rfid;
        }

        async function registerCurrentTag() {
            if (!currentRegistrationTag) return;
            
            const rfId = document.getElementById('rfIdInput').value.trim();
            const paletteNumber = document.getElementById('paletteNumberInput').value.trim();
            const name = document.getElementById('nameInput').value.trim();
            
            // Validate inputs - at least RFID is required, palette and name are optional but at least one should be provided
            if (!rfId) {
                showRegistrationStatus('Please enter or generate an RFID', 'error');
                return;
            }
            
            if (!paletteNumber && !name) {
                showRegistrationStatus('Please enter either a palette number or name (or both)', 'error');
                return;
            }

            try {
                showRegistrationStatus('Registering tag...', '');
                
                const requestData = {
                    tag_id: currentRegistrationTag.tag_hex,
                    rf_id: rfId
                };
                
                // Add optional fields only if they have values
                if (paletteNumber) {
                    requestData.palette_number = parseInt(paletteNumber);
                }
                if (name) {
                    requestData.name = name;
                }
                
                const response = await fetch('/api/register-tag', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const result = await response.json();
                
                if (result.success) {
                    showRegistrationStatus('‚úÖ Tag registered successfully!', 'success');
                    setTimeout(() => {
                        closeRegistrationModal();
                    }, 1500);
                } else {
                    showRegistrationStatus('‚ùå ' + (result.error || 'Registration failed'), 'error');
                }
            } catch (error) {
                console.error('Registration error:', error);
                showRegistrationStatus('‚ùå Network error', 'error');
            }
        }

        async function skipCurrentTag() {
            if (!currentRegistrationTag) return;

            try {
                const response = await fetch('/api/skip-registration', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        tag_id: currentRegistrationTag.tag_hex
                    })
                });

                const result = await response.json();
                
                if (result.success) {
                    showRegistrationStatus('‚è≠Ô∏è Tag registration skipped', 'success');
                    setTimeout(() => {
                        closeRegistrationModal();
                    }, 1000);
                } else {
                    showRegistrationStatus('‚ùå ' + (result.error || 'Skip failed'), 'error');
                }
            } catch (error) {
                console.error('Skip error:', error);
                showRegistrationStatus('‚ùå Network error', 'error');
            }
        }

        function showRegistrationStatus(message, type) {
            const statusElement = document.getElementById('registrationStatus');
            statusElement.textContent = message;
            statusElement.className = 'registration-status' + (type ? ' ' + type : '');
        }

        async function checkPendingRegistrations() {
            try {
                const response = await fetch('/api/pending-registrations');
                const result = await response.json();
                
                if (result.success && result.data.queue.length > 0) {
                    // Show modal for first pending tag
                    const firstTagId = result.data.queue[0];
                    const tagData = result.data.pending_tags[firstTagId];
                    
                    if (tagData && tagData.awaiting_input) {
                        showRegistrationModal(tagData);
                    }
                }
            } catch (error) {
                console.error('Error checking pending registrations:', error);
            }
        }

        // Enhanced update function to handle registration
        function updateData(data) {
            if (data.statistics) {
                updateStatistics(data.statistics);
            }
            
            if (data.active_tags) {
                updateTags(data.active_tags);
            }
            
            if (data.recent_activity) {
                updateActivity(data.recent_activity);
            }
            
            // Update connection status from data
            if (data.statistics && data.statistics.connection_status) {
                updateConnectionStatus(
                    data.statistics.connection_status.toLowerCase().includes('connected'),
                    data.statistics.connection_status
                );
            }
            
            // Check for new pending registrations
            if (data.pending_registrations && Object.keys(data.pending_registrations).length > 0) {
                // Only show modal if no modal is currently open
                const modal = document.getElementById('registrationModal');
                if (modal.style.display === 'none' && data.registration_queue.length > 0) {
                    const firstTagId = data.registration_queue[0];
                    const tagData = data.pending_registrations[firstTagId];
                    
                    if (tagData && tagData.awaiting_input) {
                        setTimeout(() => showRegistrationModal(tagData), 500);
                    }
                }
            }
            
            // Update last update time
            document.getElementById('lastUpdate').textContent = new Date().toLocaleTimeString();
        }

        // Enter key support for registration inputs
        document.addEventListener('DOMContentLoaded', function() {
            const inputs = ['rfIdInput', 'paletteNumberInput', 'nameInput'];
            inputs.forEach(inputId => {
                document.getElementById(inputId).addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        registerCurrentTag();
                    }
                });
            });
        });

        // Initial page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('RFID Dashboard loaded');
            setTimeout(refreshData, 1000);
            
            // Check for pending registrations on load
            setTimeout(checkPendingRegistrations, 2000);
        });
    </script>
</body>
</html>
